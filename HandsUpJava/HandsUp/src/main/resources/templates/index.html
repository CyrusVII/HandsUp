<!DOCTYPE html>
<html lang="it" xmlns:th="http://www.thymeleaf.org">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="asset/css/styles.css">

<script src="/asset/JS/JsSingup.js" defer></script>
<title>HandsUp</title>

</head>

<body>
	<!-- Header del sito -->
	<header>
		<div class="logo">
			<img src="/asset/img/HANDSUPcircle.png" class="profile-img"
				style="width: 50px; height: 50px;">
		</div>
		<div class="search-bar">
			<input type="text" placeholder="Cerca...">
		</div>
		<div class="user-profile">
			<p th:text="${username}" style="margin-right: 5px;"></p>
			<label class="popup"> <input type="checkbox">
				<div tabindex="0" class="burger">
					<!-- Immagine profilo per l'utente -->
					<img th:if="${userType == 'ROLE_USER'}"
						th:src="@{'http://localhost:8080/users/' + ${username} + '/profile-picture'}"
						class="profile-img">

					<!-- Immagine profilo per l'azienda -->
					<img th:if="${userType == 'ROLE_COMPANY'}"
						th:src="@{'http://localhost:8080/azienda/' + ${username} + '/profile-picture'}"
						class="profile-img">

				</div>
				<nav class="popup-window">
					<legend>Menu</legend>
					<ul>
						<li>
							<form id="ProfiloFrom" th:action="@{/profilo}" method="get">
								<button>
									<svg width="14" height="14" viewBox="0 0 24 24" fill="none"
										stroke="currentColor" stroke-width="1.2"
										stroke-linecap="round" xmlns="http://www.w3.org/2000/svg">
                                        <path
											d="M12 2c-2.209 0-4 1.791-4 4s1.791 4 4 4 4-1.791 4-4-1.791-4-4-4zM12 10c-2.209 0-4 1.791-4 4v6h8v-6c0-2.209-1.791-4-4-4z"></path>
                                    </svg>
									<span>Profilo</span>
								</button>
							</form>
						</li>
						<li>
						<form id="PaginaVolontriato" name="PaginaVolontriato" th:action="@{/PaginaPerLaCandidaturaVolontariato}">
							<button>
								<svg width="14" height="14" viewBox="0 0 24 24" fill="none"
									stroke="currentColor" stroke-width="1.2" stroke-linecap="round"
									xmlns="http://www.w3.org/2000/svg">
                                    <path
										d="M16.5 6.5c1.1 0 2 .9 2 2s-.9 2-2 2h-2.7c.3 1.2 1.4 2.1 2.7 2.1 1.6 0 3-1.4 3-3s-1.4-3-3-3c-1.4 0-2.4 1-2.9 2.1H9V9h4.6c.1 1 .4 2 1.3 2.7v.2c-.7.5-1.6.9-2.5.9-2.5 0-4.4-1.9-4.4-4.4s1.9-4.4 4.4-4.4c1.5 0 2.8.8 3.4 2h.4c-1.2-1.8-3.3-3-5.8-3C7.6 4 5 6.6 5 10s2.6 6 5.8 6c1.4 0 2.6-.5 3.6-1.3 1.2 1.4 3 2.3 5.1 2.3 3.3 0 6-2.7 6-6s-2.7-6-6-6c-2.2 0-4 1.1-5.2 2.7-.4-.1-.8-.2-1.2-.2-2.8 0-5 2.2-5 5s2.3 5 5 5c1.3 0 2.4-.5 3.3-1.3.8 2 2.8 3.3 5.1 3.3 3.3 0 6-2.7 6-6s-2.7-6-6-6c-1.2 0-2.2.4-3.1 1.1-.9-.6-2-.9-3.2-.9-2.7 0-5 2.2-5 5s2.3 5 5 5z"></path>
                                </svg>
								<span>Cerca/Proponi</span>
							</button>
							</form>
						</li>
						<li>
							<form id="PostFrom" th:action="@{/PaginaDiCaricamentoPost}"
								method="get">
								<button type="submit">
									<svg width="14" height="14" viewBox="0 0 24 24" fill="none"
										stroke="currentColor" stroke-width="1.2"
										stroke-linecap="round" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M12 5v14m-7-7h14"></path>
                                    </svg>
									<span>Crea Post</span>
								</button>
							</form>
						</li>
						<li>
						<form id="ChiSiamo" name="ChiSiamo" th:action="@{/ChiSiamo}">
							<button>
								<svg width="14" height="14" viewBox="0 0 24 24" fill="none"
									stroke="currentColor" stroke-width="1.2" stroke-linecap="round"
									xmlns="http://www.w3.org/2000/svg">
                                    <path
										d="M16.5 6.5c1.1 0 2 .9 2 2s-.9 2-2 2h-2.7c.3 1.2 1.4 2.1 2.7 2.1 1.6 0 3-1.4 3-3s-1.4-3-3-3c-1.4 0-2.4 1-2.9 2.1H9V9h4.6c.1 1 .4 2 1.3 2.7v.2c-.7.5-1.6.9-2.5.9-2.5 0-4.4-1.9-4.4-4.4s1.9-4.4 4.4-4.4c1.5 0 2.8.8 3.4 2h.4c-1.2-1.8-3.3-3-5.8-3C7.6 4 5 6.6 5 10s2.6 6 5.8 6c1.4 0 2.6-.5 3.6-1.3 1.2 1.4 3 2.3 5.1 2.3 3.3 0 6-2.7 6-6s-2.7-6-6-6c-2.2 0-4 1.1-5.2 2.7-.4-.1-.8-.2-1.2-.2-2.8 0-5 2.2-5 5s2.3 5 5 5c1.3 0 2.4-.5 3.3-1.3.8 2 2.8 3.3 5.1 3.3 3.3 0 6-2.7 6-6s-2.7-6-6-6c-1.2 0-2.2.4-3.1 1.1-.9-.6-2-.9-3.2-.9-2.7 0-5 2.2-5 5s2.3 5 5 5z"></path>
                                </svg>
								<span>Chi siamo</span>
							</button>
							</form>
						</li>
						<li>
							<form id="LogOut" name="LogOut" th:action="@{/logout}"
								method="post">
								<button id="logout">
									<svg width="14" height="14" viewBox="0 0 24 24" fill="none"
										stroke="currentColor" stroke-width="1.2"
										stroke-linecap="round" xmlns="http://www.w3.org/2000/svg">
                                        <path
											d="M2.598 9h-1.055c1.482-4.638 5.83-8 10.957-8 6.347 0 11.5 5.153 11.5 11.5s-5.153 11.5-11.5 11.5c-5.127 0-9.475-3.362-10.957-8h1.055c1.443 4.076 5.334 7 9.902 7 5.795 0 10.5-4.705 10.5-10.5s-4.705-10.5-10.5-10.5c-4.568 0-8.459 2.923-9.902 7zm12.228 3l-4.604-3.747.666-.753 6.112 5-6.101 5-.679-.737 4.608-3.763h-14.828v-1h14.826z"></path>
                                    </svg>
									<span>Log Out</span>
								</button>
							</form>
						</li>
					</ul>
				</nav>
			</label>
		</div>
	</header>

	<!-- Contenitore principale -->
	<div class="container">
		<div class="main-content">
			<!-- Itera sui post -->

			<div th:each="post : ${posts}" class="post"
				th:id="'post-' + ${post.id}">
				<div th:if="${post.utente != null and post.azienda == null}">
					<div class="post-user-info">
						<img
							th:src="@{'http://localhost:8080/users/' + ${post.utente.username} + '/profile-picture'}"
							class="profile-img">
						<h3 th:text="${post.utente.username}"></h3>
						<div th:if="${post.utente.username == username}"
							class="post-options">
							<button>&#8226;&#8226;&#8226;</button>
							<div class="dropdown-content">
								<a href="#">Modifica</a>
								<button type="button" th:data="${post.id}" th:usernameU="${username}"
									onclick="openDeletePostPopup(this.getAttribute('usernameU'), this.getAttribute('data'))"
									style="font-size: 17px; margin-left: 10px; color: black;">Elimina</button>


							</div>
						</div>
					</div>

					<img
						th:src="@{'/users/' + ${post.utente.username} + '/posts/' + ${post.id} + '/image'}"
						class="post-image" height="400" width="600"> <br>
					<p th:text="${post.testo}"></p>
					<br>
					<p th:text="${#dates.format(post.dataPubblicazione, 'dd-MM-yyyy')}"></p>

					<div class="reactions">
						<div class="like post-actions">
							<button class="like-button" th:data="${post.id}"
								onclick="handleLike(this.getAttribute('data'));"
								style="border: none; background: none; padding: 0;">
								<img src="asset/img/like.png" alt="Mi Piace" height="30"
									width="30"> <span th:text="${post.miPiace}"
									style="display: block; text-align: center;"></span>
							</button>
						</div>

						<div class="dislike">
							<button class="dislike-button" th:data="${post.id}"
								onclick="handleDislike(this.getAttribute('data'));"
								style="border: none; background: none; padding: 0;">
								<img src="/asset/img/dislike.png" alt="Non Mi Piace" height="30"
									width="30"> <span th:text="${post.nonMiPiace}"
									style="display: block; text-align: center;"></span>
							</button>
						</div>





						<form id="commentFormU"
							th:if="${post.utente.username != username}" th:dataU="${post.id}"
							th:usernameU="${username}" th:data-user-role="${userType}"
							style="display: flex; align-items: flex-start;">
							<div class="search-bar">
								<input type="text" id="commentInputU" placeholder="Commenta..."
									style="width: 250px; margin-right: 10px; margin-left: 5px;">
							</div>
							<button type="submit" class="like-btn"
								style="padding: 8px 16px; margin-left: 30px;">invia</button>
						</form>




						<button th:data="${post.id}"
							onclick="openRegisterPopup(this.getAttribute('data'))"
							class="like-btn2"
							style="padding: 8px 16px; margin-left: auto; background-color: #ddd; border: none; cursor: pointer;">
							Commenti</button>

					</div>
				</div>

				<!-- POST DEL AZIENDA -->
				<div th:if="${post.azienda != null and post.utente == null}">
					<div class="post-user-info">
						<img
							th:src="@{'http://localhost:8080/azienda/' + ${post.azienda.username} + '/profile-picture'}"
							class="profile-img">
						<h3 th:text="${post.azienda.username}"></h3>
						<div th:if="${post.azienda.username == username}"
							class="post-options">
							<button>&#8226;&#8226;&#8226;</button>
							<div class="dropdown-content">
								<a href="#">Modifica</a>
								<button type="button" th:data="${post.id}" th:username="${username}"
									onclick="openDeletePostPopupA(this.getAttribute('username'), this.getAttribute('data'))"
									style="font-size: 17px; margin-left: 10px; color: black;">Elimina</button>
							</div>
						</div>
					</div>

					<img
						th:src="@{'/users/' + ${post.azienda.username} + '/posts/' + ${post.id} + '/image'}"
						class="post-image" height="400" width="600"> <br>
					<p th:text="${post.testo}"></p>
					<br>
					<p th:text="${#dates.format(post.dataPubblicazione, 'dd-MM-yyyy')}"></p>

					<div class="reactions">
						<div class="like post-actions">
							<button class="like-button" th:data="${post.id}"
								onclick="handleLike(this.getAttribute('data'));"
								style="border: none; background: none; padding: 0;">
								<img src="asset/img/like.png" alt="Mi Piace" height="30"
									width="30"> <span th:text="${post.miPiace}"
									style="display: block; text-align: center;"></span>
							</button>
						</div>

						<div class="dislike">
							<button class="dislike-button" th:data="${post.id}"
								onclick="handleDislike(this.getAttribute('data'));"
								style="border: none; background: none; padding: 0;">
								<img src="/asset/img/dislike.png" alt="Non Mi Piace" height="30"
									width="30"> <span th:text="${post.nonMiPiace}"
									style="display: block; text-align: center;"></span>
							</button>
						</div>

						<form id="commentForm"
							th:if="${post.azienda.username != username}" th:data="${post.id}"
							th:username="${username}" th:data-user-role="${userType}"
							style="display: flex; align-items: flex-start;">
							<div class="search-bar">
								<input type="text" id="commentInput" placeholder="Commenta..."
									style="width: 250px; margin-right: 10px; margin-left: 5px;">
							</div>
							<button type="submit" class="like-btn"
								style="padding: 8px 16px; margin-left: 30px;">invia</button>
						</form>

						<button th:data="${post.id}"
							onclick="openRegisterPopup(this.getAttribute('data'))"
							class="like-btn2"
							style="padding: 8px 16px; margin-left: auto; background-color: #ddd; border: none; cursor: pointer;">
							Commenti</button>

						<!-- Lista dei commenti -->
						<div id="registerPopup" class="commenti hidden">
							<div id="commentsContainer">
								<!-- Qui vengono aggiunti dinamicamente i commenti -->
							</div>
							<button type="button" onclick="closeRegisterForm()"
								class="commenti-button">Chiudi</button>
						</div>
					</div>

				</div>
			</div>
		</div>

		<!-- Utenti Seguiti -->
		<div class="followed-users">
			<h2>Utenti seguiti</h2>
			<ul>
				<li th:each="utente : ${followedUsers}"><img
					th:src="@{'/users/' + ${utente.username} + '/profile-picture'}"
					class="profile-img"> <span th:text="${utente.username}"></span>
				</li>
			</ul>
		</div>
	</div>

	<div id="success-message"
		style="display: none; position: fixed; bottom: 10px; right: 10px; background-color: #4CAF50; color: white; padding: 15px; border-radius: 5px;">
		Commento caricato con successo!</div>

	<!-- Footer del sito -->
	<footer>
		<p>&copy; 2024 <a href="PaginaDiErrore404.html">HandsUp</a>. Tutti i diritti riservati.</p>
	</footer>
	<script>
		async function handleLike(id) {
			try {
				const response = await
				fetch(`http://localhost:8080/${id}/like`, {
					method : 'POST',
					headers : {
						'Content-Type' : 'application/json',
					// Aggiungi eventuali token JWT o altri header di autenticazione/autorizzazione qui
					},
				});

				if (!response.ok) {
					throw new Error('Errore durante il like');
				}

				// Aggiorna la UI per riflettere il conteggio aggiornato dei like
				const likeCountElement = document
						.querySelector(`#post-${id} .like-button span`);
				const currentLikes = parseInt(likeCountElement.innerText);
				likeCountElement.innerText = currentLikes + 1;
			} catch (error) {
				console.error('Errore durante il like:', error);
				// Gestisci l'errore in modo appropriato, ad esempio mostrando un messaggio all'utente
			}
		}

		async function handleDislike(id) {
			try {
				const response = await
				fetch(`http://localhost:8080/${id}/dislike`, {
					method : 'POST',
					headers : {
						'Content-Type' : 'application/json',
					// Aggiungi eventuali token JWT o altri header di autenticazione/autorizzazione qui
					},
				});

				if (!response.ok) {
					throw new Error('Errore durante il dislike');
				}

				// Aggiorna la UI per riflettere il conteggio aggiornato dei like
				const likeCountElement = document
						.querySelector(`#post-${id} .dislike-button span`);
				const currentLikes = parseInt(likeCountElement.innerText);
				likeCountElement.innerText = currentLikes + 1;
			} catch (error) {
				console.error('Errore durante il dislike:', error);
				// Gestisci l'errore in modo appropriato, ad esempio mostrando un messaggio all'utente
			}
		}

		// Funzione per aprire o chiudere il form di registrazione
		// Funzione per aprire o chiudere il form di registrazione
// Funzione per aprire il popup dei commenti per un post specifico
function openRegisterPopup(id) {
    const registerPopup = document.getElementById("registerPopup");
    registerPopup.classList.remove("hidden");

    const commentsContainer = document.getElementById("commentsContainer");
    commentsContainer.innerHTML = "<p>Caricamento in corso...</p>";

    fetch(`/comments/${id}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Errore HTTP ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            const commentsForPost = data.filter(comment => comment.postId == id);

            if (commentsForPost.length === 0) {
                commentsContainer.innerHTML = "<p>Nessun commento disponibile per questo post.</p>";
                return;
            }

            commentsContainer.innerHTML = ""; // Pulisce il messaggio di caricamento iniziale

            // Itera sui commenti e aggiungili al contenuto del popup
            commentsForPost.forEach(comment => {
                const commentElement = document.createElement("div");

                // Handling of company image in comments
                let aziendaImageSrc = comment.aziendaImmagine || '';
                

                // Handling of user image in comments
                let utenteImageSrc = comment.utenteImmagine || ''; // Usa direttamente UtenteImmagine dal DTO

                // Default placeholder image in case neither user nor company image is available
                const placeholderImage = 'placeholder.jpg';

                commentElement.innerHTML = `
                    <div class="comment">
                        <img src="${utenteImageSrc || aziendaImageSrc || placeholderImage}" class="profile-imga" style="width: 50px; height: 50px;">
                        <div class="comment-content">
                            <strong>${comment.utenteUsername || comment.aziendaUsername}</strong>
                            <p>${comment.testo}</p>
                        </div>
                    </div>
                `;

                commentsContainer.appendChild(commentElement);
            });
        })
        .catch(error => {
            console.error('Errore nel caricamento dei commenti:', error);
            commentsContainer.innerHTML = "<p>Si è verificato un errore durante il caricamento dei commenti.</p>";
        });
}







		// Funzione per chiudere il popup del form di registrazione
		function closeRegisterForm() {
			const registerPopup = document.getElementById("registerPopup");
			registerPopup.classList.add("hidden");
		}
		
		
		
		//Ottieni il riferimento al form e agli elementi di input
		 const commentForm = document.getElementById('commentForm');
		 const commentInput = document.getElementById('commentInput');

		 // Aggiungi un evento di submit al form
		 commentForm.addEventListener('submit', function(event) {
		     event.preventDefault(); // Evita il comportamento predefinito del form (ricarica della pagina)

		     // Ottieni il valore del commento dall'input
		     const commentText = commentInput.value.trim();

		     // Assicurati che il commento non sia vuoto
		     if (commentText === '') {
		         alert('Inserisci un commento prima di inviare!');
		         return;
		     }

		     // Ottieni l'ID del post a cui si sta rispondendo
		     const postId = commentForm.getAttribute('data');
		     const username = commentForm.getAttribute('username');
		     const userRole = commentForm.getAttribute('data-user-role');

		     const paramUsername = (userRole === 'ROLE_COMPANY') ? 'azienda_username' : 'utente_username';
		     const apiEndpoint = (userRole === 'ROLE_COMPANY') ? `/commentsA/crea/${postId}` : `/comments/crea/${postId}`;

		     // Esegui la chiamata fetch per inviare il commento al backend
		     fetch(`${apiEndpoint}?${paramUsername}=${username}&testo=${commentText}`, {
		         method: 'PUT', // Metodo HTTP PUT per corrispondere al controller Spring Boot
		         headers: {
		             'Content-Type': 'application/json',
		             // Aggiungi eventuali token JWT o altri header di autenticazione/autorizzazione qui
		         },
		         // Non è necessario includere il body in questo caso, poiché i parametri sono nel percorso URL e nelle query
		     })
		     .then(response => {
		         if (!response.ok) {
		             throw new Error('Errore ' + response.status);
		         }
		         return response.json();
		     })
		     .then(data => {
   // Manipola la risposta o aggiorna l'interfaccia utente come necessario
   console.log('Commento inviato con successo:', data);
   
   // Mostra il messaggio di successo
   const successMessage = document.getElementById('success-message');
   successMessage.style.display = 'block';

   // Nascondi il messaggio dopo 3 secondi
   setTimeout(() => {
       successMessage.style.display = 'none';
   }, 3000);

   // Resetta il valore dell'input dopo l'invio
   commentInput.value = '';
})
		     .catch(error => {
		         console.error('Errore durante l\'invio del commento:', error);
		         alert('Si è verificato un errore durante l\'invio del commento.');
		     });
		 });
		
		
		

		 //Ottieni il riferimento al form e agli elementi di input
		 const commentFormU = document.getElementById('commentFormU');
		 const commentInputU = document.getElementById('commentInputU');

		 // Aggiungi un evento di submit al form
		 commentFormU.addEventListener('submit', function(event) {
		     event.preventDefault(); // Evita il comportamento predefinito del form (ricarica della pagina)

		     // Ottieni il valore del commento dall'input
		     const commentTextU = commentInputU.value.trim();

		     // Assicurati che il commento non sia vuoto
		     if (commentTextU === '') {
		         alert('Inserisci un commento prima di inviare!');
		         return;
		     }

		     // Ottieni l'ID del post a cui si sta rispondendo
		     const postIdU = commentFormU.getAttribute('dataU');
		     const usernameU = commentFormU.getAttribute('usernameU');
		     const userRole = commentForm.getAttribute('data-user-role');

		     const paramUsername = (userRole === 'ROLE_COMPANY') ? 'azienda_username' : 'utente_username';
		     const apiEndpoint = (userRole === 'ROLE_COMPANY') ? `/commentsA/crea/${postId}` : `/comments/crea/${postId}`;

		     // Esegui la chiamata fetch per inviare il commento al backend
		     fetch(`${apiEndpoint}?${paramUsername}=${username}&testo=${commentText}`, {
		         method: 'PUT', // Metodo HTTP PUT per corrispondere al controller Spring Boot
		         headers: {
		             'Content-Type': 'application/json',
		             // Aggiungi eventuali token JWT o altri header di autenticazione/autorizzazione qui
		         },
		         // Non è necessario includere il body in questo caso, poiché i parametri sono nel percorso URL e nelle query
		     })
		     .then(response => {
		         if (!response.ok) {
		             throw new Error('Errore ' + response.status);
		         }
		         return response.json();
		     })
		     .then(data => {
    // Manipola la risposta o aggiorna l'interfaccia utente come necessario
    console.log('Commento inviato con successo:', data);
    
    // Mostra il messaggio di successo
    const successMessage = document.getElementById('success-message');
    successMessage.style.display = 'block';

    // Nascondi il messaggio dopo 3 secondi
    setTimeout(() => {
        successMessage.style.display = 'none';
    }, 3000);

    // Resetta il valore dell'input dopo l'invio
    commentInputU.value = '';
})
		     .catch(error => {
		         console.error('Errore durante l\'invio del commento:', error);
		         alert('Si è verificato un errore durante l\'invio del commento.');
		     });
		 });

		 
		// Function to open the delete post confirmation popup
		 function openDeletePostPopup(username, postId) {
		     if (confirm("Sei sicuro di voler eliminare questo post?")) {
		         // Form submission for post deletion
		         const deleteForm = document.createElement('form');
		         deleteForm.method = 'POST';
		         deleteForm.action = `/users/${username}/posts/${postId}/delete`;
		         deleteForm.style.display = 'none'; // Hide the form

		         document.body.appendChild(deleteForm); // Append the form to the body
		         deleteForm.submit(); // Submit the form
		     }
		 }
		
		 function openDeletePostPopupA(username, postId) {
		     if (confirm("Sei sicuro di voler eliminare questo post?")) {
		         // Form submission for post deletion
		         const deleteForm = document.createElement('form');
		         deleteForm.method = 'POST';
		         deleteForm.action = `/azienda/${username}/posts/${postId}/delete`;
		         deleteForm.style.display = 'none'; // Hide the form

		         document.body.appendChild(deleteForm); // Append the form to the body
		         deleteForm.submit(); // Submit the form
		     }
		 }
		
		 

	</script>
</body>

</html>